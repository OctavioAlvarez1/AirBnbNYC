# üèôÔ∏è Airbnb NYC Data Lake ‚Äî AWS S3 + Athena + PySpark + Power BI

**Autor:** Octavio Alvarez
**Stack:** AWS S3 ¬∑ AWS Glue ¬∑ Amazon Athena ¬∑ PySpark ¬∑ Power BI
**Nivel:** Data Engineer ¬∑ Data Analyst
**Dataset:** [Airbnb NYC (Kaggle)](https://www.kaggle.com/datasets/dgomonov/new-york-city-airbnb-open-data)

---

## üß© Descripci√≥n General

Este proyecto implementa un **pipeline de datos end-to-end** en la nube con arquitectura de capas (**Bronze ‚Üí Silver ‚Üí Gold**), aplicando principios de **idempotencia**, limpieza de datos y an√°lisis exploratorio con **PySpark**, para finalmente conectar los resultados a un **dashboard interactivo en Power BI**.

La soluci√≥n se ejecuta 100% en el ecosistema de **AWS**, aprovechando sus servicios serverless:

* **Amazon S3:** almacenamiento de datos crudos y procesados.
* **AWS Glue:** cat√°logo de metadatos para Athena.
* **Amazon Athena:** consultas SQL sobre los datos en S3.
* **PySpark (Athena Notebook):** an√°lisis exploratorio y validaci√≥n de calidad.
* **Power BI:** visualizaci√≥n de KPIs y m√©tricas clave.

---

## üè∑Ô∏è Arquitectura del Pipeline

<img src="Imagenes/pipeline.png" alt="Pipeline AWS Airbnb NYC" width="800"/>

### üìö Flujo de Datos

| Capa       | Descripci√≥n                                                | Ubicaci√≥n                                   |
| ---------- | ---------------------------------------------------------- | ------------------------------------------- |
| **Bronze** | Dataset crudo cargado desde Kaggle (CSV).                  | `s3://airbnb-nyc-datalake-oalvarez/bronze/` |
| **Silver** | Datos filtrados y limpios, formato Parquet, particionados. | `s3://airbnb-nyc-datalake-oalvarez/silver/` |
| **Gold**   | Tabla agregada con KPIs listos para visualizaci√≥n.         | `s3://airbnb-nyc-datalake-oalvarez/gold/`   |

---

## ‚öôÔ∏è ETL en Amazon Athena

El proceso ETL se realiz√≥ directamente en **Athena**, lo que permiti√≥ ejecutar SQL sobre S3 sin necesidad de infraestructura adicional.

---

### ü•úÔ∏è Capa Bronze ‚Üí ü•ò Capa Silver (Limpieza e idempotencia)

```sql
-- Creaci√≥n capa Silver idempotente
DROP TABLE IF EXISTS airbnb_silver;

CREATE TABLE airbnb_silver
WITH (
  format = 'PARQUET',
  external_location = 's3://airbnb-nyc-datalake-oalvarez/silver/',
  partitioned_by = ARRAY['neighbourhood_group']
) AS
SELECT DISTINCT
  id,
  name,
  host_id,
  host_name,
  neighbourhood,
  latitude,
  longitude,
  room_type,
  price,
  minimum_nights,
  number_of_reviews,
  reviews_per_month,
  calculated_host_listings_count,
  availability_365,
  neighbourhood_group
FROM airbnb_bronze
WHERE price BETWEEN 10 AND 1000
  AND number_of_reviews > 0
  AND availability_365 > 0;
```

‚úÖ **Qu√© hace:**

* Filtra precios fuera de rango.
* Elimina alojamientos sin reviews o sin disponibilidad.
* Guarda el resultado optimizado en Parquet.
* Particiona por `neighbourhood_group`.
* Usa `DROP TABLE IF EXISTS` y `SELECT DISTINCT` para **idempotencia**.

---

### ü•ò Capa Silver ‚Üí ü•á Capa Gold (Agregaci√≥n y KPIs)

```sql
-- Creaci√≥n capa Gold idempotente
DROP TABLE IF EXISTS airbnb_gold;

CREATE TABLE airbnb_gold
WITH (
  format = 'PARQUET',
  external_location = 's3://airbnb-nyc-datalake-oalvarez/gold/'
) AS
SELECT
  neighbourhood_group,
  neighbourhood,
  room_type,
  ROUND(AVG(price), 2) AS avg_price,
  COUNT(DISTINCT id) AS total_listings,
  SUM(price * minimum_nights) AS total_income_estimate
FROM airbnb_silver
GROUP BY 1, 2, 3;
```

üìä **KPIs generados:**

* `avg_price`: precio promedio por tipo de habitaci√≥n.
* `total_listings`: cantidad total de alojamientos √∫nicos.
* `total_income_estimate`: ingreso total estimado.

üß© **Idempotencia:**
Cada ejecuci√≥n reemplaza la versi√≥n anterior, asegurando resultados consistentes y reproducibles.

---

## üß† Exploratory Data Analysis (EDA) ‚Äî PySpark en Athena Notebook

El an√°lisis exploratorio se realiz√≥ directamente en **Athena Notebooks** usando **PySpark**, accediendo a la tabla `airbnb_gold` registrada en **Glue Catalog**.

```python
# Cargo la tabla desde Glue Catalog
df_gold = spark.sql("SELECT * FROM airbnb_nyc_db.airbnb_gold")

print("Total de registros:", df_gold.count())
df_gold.printSchema()
df_gold.show(5)
```

### üßπ Calidad de Datos

* Sin valores nulos ni duplicados.
* Estructura final consolidada con 6 columnas.
* Dataset preparado para an√°lisis y visualizaci√≥n.

---

### üìà Estad√≠sticas descriptivas

```python
df_gold.describe(["avg_price", "total_listings", "total_income_estimate"]).show()
```

| M√©trica                   | Media      | M√≠nimo | M√°ximo | œÉ       |
| ------------------------- | ---------- | ------ | ------ | ------- |
| **avg_price**             | 106.8 USD  | 13     | 800    | 70.1    |
| **total_listings**        | 45         | 1      | 954    | 114.6   |
| **total_income_estimate** | 41,983 USD | 13     | 1.3M   | 147,443 |

üìä **Conclusi√≥n:**
Alta dispersi√≥n de precios y concentraci√≥n de ingresos en Manhattan y Brooklyn.

---

### üíµ Detecci√≥n de Outliers (IQR)

```python
percentiles = df_gold.approxQuantile("avg_price", [0.25, 0.5, 0.75], 0.05)
q1, q2, q3 = percentiles
iqr = q3 - q1
lim_inf = q1 - 1.5 * iqr
lim_sup = q3 + 1.5 * iqr
```

üß© **Resultados:**

* Rango t√≠pico: $55 ‚Äì $235 USD
* 25 outliers detectados (principalmente en Tribeca, SoHo, Chelsea y Flatiron).
* Corresponden a alojamientos premium o de lujo.

‚úÖ Distribuci√≥n coherente con la estructura del mercado de Airbnb NYC.

---

### üèôÔ∏è An√°lisis por Zona

```python
spark.sql("""
SELECT
  neighbourhood_group,
  SUM(total_listings) AS total_listings,
  ROUND(AVG(avg_price), 2) AS avg_price,
  ROUND(SUM(total_income_estimate) / SUM(total_listings), 2) AS avg_income_per_listing
FROM airbnb_nyc_db.airbnb_gold
GROUP BY neighbourhood_group
ORDER BY total_listings DESC
""").show()
```

| Zona          | Total Listings | Precio Promedio | Ingreso Promedio |
| ------------- | -------------- | --------------- | ---------------- |
| Manhattan     | 9316           | 152.6           | 1401.0           |
| Brooklyn      | 9004           | 108.0           | 688.9            |
| Queens        | 2980           | 95.9            | 369.8            |
| Bronx         | 662            | 89.9            | 285.3            |
| Staten Island | 236            | 90.2            | 286.2            |

üìä **Interpretaci√≥n:**
Manhattan lidera en rentabilidad.
Brooklyn y Queens tienen la mayor oferta y volumen de propiedades activas.

---

### üîó Correlaciones entre variables

```python
df_corr = df_gold.select("avg_price", "total_listings", "total_income_estimate").toPandas()
df_corr.corr(method="pearson")
```

| Variable 1                             | Variable 2 | Correlaci√≥n                  | Interpretaci√≥n |
| -------------------------------------- | ---------- | ---------------------------- | -------------- |
| avg_price ‚Üî total_listings             | 0.21       | Relaci√≥n d√©bil y positiva    |                |
| avg_price ‚Üî total_income_estimate      | 0.36       | Correlaci√≥n moderada         |                |
| total_listings ‚Üî total_income_estimate | 0.77       | Correlaci√≥n fuerte y directa |                |

‚úÖ **Conclusi√≥n:**
El ingreso total depende principalmente del volumen de propiedades, potenciado por los precios promedio altos en zonas premium.

---

## üìä Dashboard en Power BI

Conexi√≥n mediante **Amazon Athena ODBC Driver**, utilizando la tabla `airbnb_gold` del Glue Catalog.

<img src="Imagenes/dash.png" alt="Pipeline AWS Airbnb NYC" width="800"/>

### KPIs Principales

* üíµ **Average Price**
* üè®Ô∏è **Total Listings**
* üìç **Neighbourhood Groups**
* üè† **% Entire Home/Apt**
* üåÜ **% Manhattan Properties**

### Visualizaciones

* Mapa geogr√°fico interactivo de NYC.
* Gr√°fico de barras comparando distritos.
* KPI Cards con totales y promedios.
* Distribuci√≥n de precios y tipos de alojamiento.

---

## üîÅ Idempotencia en el Pipeline

El flujo es **idempotente**, es decir:

> ‚ÄúEjecutarlo m√∫ltiples veces produce siempre el mismo resultado.‚Äù

### Estrategias aplicadas:

* `DROP TABLE IF EXISTS` ‚Üí evita duplicaci√≥n de tablas.
* `SELECT DISTINCT` ‚Üí elimina registros repetidos.
* `COUNT(DISTINCT id)` ‚Üí evita sobrecontar alojamientos.
* **Sobrescritura controlada en S3** (sin rutas din√°micas).

‚úÖ Garantiza consistencia, reproducibilidad y limpieza del Data Lake.

---

## üöÄ Futuras Mejoras ‚Äî Orquestaci√≥n con Apache Airflow

> ‚ÄúEl pipeline actual podr√≠a automatizarse con Airflow, definiendo un DAG con tareas secuenciales para crear las capas Silver y Gold, validar la calidad de datos y refrescar el dashboard de Power BI.‚Äù

```python
# Ejemplo simplificado de DAG
from airflow import DAG
from airflow.providers.amazon.aws.operators.athena import AthenaOperator
from datetime import datetime

with DAG('airbnb_pipeline_dag', start_date=datetime(2025,10,17), schedule='@daily', catchup=False) as dag:
    silver = AthenaOperator(
        task_id='create_silver',
        query='SQL de capa Silver',
        database='airbnb_nyc_db',
        output_location='s3://airbnb-nyc-datalake-oalvarez/query-results/'
    )
    gold = AthenaOperator(
        task_id='create_gold',
        query='SQL de capa Gold',
        database='airbnb_nyc_db',
        output_location='s3://airbnb-nyc-datalake-oalvarez/query-results/'
    )
    silver >> gold
```

---

## ü¶Ø Conclusiones Generales

* ‚úÖ Se construy√≥ un **Data Lake estructurado** en AWS.
* ‚úÖ Se aplic√≥ **ETL completo con SQL y PySpark**.
* ‚úÖ Se garantiz√≥ **idempotencia y calidad de datos**.
* ‚úÖ Se integr√≥ con **Power BI** para an√°lisis visual.
* ‚úÖ Proyecto **escalable y apto para orquestaci√≥n futura** con Airflow.

---

## üß∞ Stack Tecnol√≥gico

| Herramienta                       | Uso                                              |
| --------------------------------- | ------------------------------------------------ |
| ü©£ **Amazon S3**                  | Almacenamiento de datos crudos y transformados   |
| üîç **AWS Glue**                   | Cat√°logo de metadatos para Athena                |
| ‚öôÔ∏è **Amazon Athena**              | Ejecuci√≥n de ETL y creaci√≥n de capas Silver/Gold |
| üß† **PySpark (Athena Notebooks)** | Validaci√≥n, EDA y correlaciones                  |
| üìä **Power BI**                   | Dashboard de visualizaci√≥n de KPIs               |
| ‚òÅÔ∏è **(Opcional) Apache Airflow**  | Orquestaci√≥n de tareas (versi√≥n futura)          |

---

## üßæ Autor

**Octavio Alvarez**
üìç Data Engineer | Data Analyst
üíª [GitHub: OctavioAlvarez1](https://github.com/OctavioAlvarez1)
üîó [LinkedIn: octavio-alvarez-6a229b223](https://www.linkedin.com/in/octavio-alvarez-6a229b223/)
